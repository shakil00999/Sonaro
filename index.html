<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonaro - ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶ï‡¶£‡ßç‡¶† ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Hind+Siliguri', sans-serif;
        }
        .custom-loader { /* Loader for audio section */
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #22d3ee;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .transition-all {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .language-list::-webkit-scrollbar { width: 6px; }
        .language-list::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        .language-list::-webkit-scrollbar-thumb { background: #06b6d4; border-radius: 3px; }
        .language-list::-webkit-scrollbar-thumb:hover { background: #0891b2; }

        audio {
            filter: invert(1) hue-rotate(180deg) brightness(1.2);
        }

        /* Modal styles */
        .modal-overlay {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .modal-scale-enter-active, .modal-scale-leave-active {
            transition: all 0.3s ease;
        }
        .modal-scale-enter-from, .modal-scale-leave-to {
            opacity: 0;
            transform: scale(0.95);
        }
        /* Custom input styles for dark theme */
        .dark-input {
            background-color: #1e293b; /* slate-800 */
            border-color: #334155; /* slate-700 */
            color: #e2e8f0; /* slate-200 */
        }
        .dark-input:focus {
            border-color: #06b6d4; /* cyan-500 */
            outline: 1px solid #06b6d4;
        }
        .dark-input::placeholder {
            color: #64748b; /* slate-500 */
        }
        .dark-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Generating Overlay Styles */
        .generating-overlay {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* slate-900 to slate-800 */
        }
        .sound-wave > div {
            background-color: #22d3ee; /* cyan-400 */
            height: 100%;
            width: 6px;
            display: inline-block;
            margin: 0 2px;
            border-radius: 3px;
            animation: soundwave-animation 1.2s infinite ease-in-out;
        }
        .sound-wave > div:nth-child(2) { animation-delay: -1.1s; }
        .sound-wave > div:nth-child(3) { animation-delay: -1.0s; }
        .sound-wave > div:nth-child(4) { animation-delay: -0.9s; }
        .sound-wave > div:nth-child(5) { animation-delay: -0.8s; }

        @keyframes soundwave-animation {
            0%, 40%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1.0); }
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 flex flex-col min-h-screen">

    <!-- Header -->
    <header id="app-header" class="w-full p-4 md:p-6 border-b border-slate-700/50 transition-opacity duration-500">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
             <h1 class="text-3xl font-bold text-white tracking-wide">‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡ßÄ ‡¶ï‡¶£‡ßç‡¶† (Sonaro)</h1>
             <p class="text-cyan-400 font-light hidden sm:block">‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§‡ßá‡¶∞ ‡¶≠‡ßü‡ßá‡¶∏ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</p>
        </div>
    </header>

    <main id="main-content" class="w-full max-w-7xl mx-auto p-4 md:p-8 flex-grow transition-opacity duration-500">
        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <!-- Left Column: Main Input & Editors -->
            <div class="lg:col-span-3 flex flex-col space-y-4">
                <div class="bg-slate-900 rounded-2xl p-6 border border-slate-700/50 flex flex-col h-full">
                    <label for="text-input" class="text-lg font-semibold text-gray-300 mb-2">‡ßß. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</label>
                    <textarea id="text-input" rows="15" class="w-full p-4 dark-input rounded-lg focus:ring-2 focus:ring-cyan-500 transition-all flex-grow border" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ï‡ßç‡¶§‡ßÉ‡¶§‡¶æ, ‡¶ï‡¶¨‡¶ø‡¶§‡¶æ ‡¶¨‡¶æ ‡¶¨‡¶∞‡ßç‡¶£‡¶®‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-xs text-gray-400 font-light">
                             <span id="auto-detect-status" class="transition-all opacity-0">‡¶≠‡¶æ‡¶∑‡¶æ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
                        </div>
                        <div id="char-counter" class="text-right text-sm text-gray-400">0 / 4500</div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 mt-4">
                        <button id="change-tone-btn" class="hidden w-full bg-slate-800 border border-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600 hover:border-indigo-500 transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                           üéôÔ∏è ‡¶≠‡ßü‡ßá‡¶∏ ‡¶ü‡ßã‡¶® ‡¶á‡¶û‡ßç‡¶ú‡¶ø‡¶®‡¶ø‡ßü‡¶æ‡¶∞
                        </button>
                        <button id="translate-script-btn" class="hidden w-full bg-slate-800 border border-slate-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 hover:border-green-500 transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                           üåê ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶‡¶ï
                        </button>
                    </div>

                    <!-- Collapsible Section for Tone -->
                    <div id="collapsible-container" class="mt-4 space-y-4">
                        <div id="custom-tone-section" class="hidden overflow-hidden transition-all duration-500 max-h-0">
                             <div class="p-4 border border-slate-700 border-dashed rounded-lg bg-slate-800/50">
                                <label for="custom-tone-input" class="text-md font-semibold text-gray-400">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶ü‡ßã‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
                                <input type="text" id="custom-tone-input" class="mt-2 w-full p-2 dark-input rounded-lg focus:ring-2 focus:ring-indigo-500 border" placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: ‡¶è‡¶ï‡¶ú‡¶® ‡¶∏‡¶Ç‡¶¨‡¶æ‡¶¶ ‡¶™‡¶æ‡¶†‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã...">
                                <button id="apply-tone-btn" class="mt-3 w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all flex items-center justify-center gap-2 transform hover:scale-102">
                                    <span id="apply-tone-loader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span> ‡¶ü‡ßã‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                                </button>
                            </div>
                        </div>
                        <!-- Translate section is now a modal -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Controls -->
            <div class="lg:col-span-2 flex flex-col space-y-6">
                <div class="bg-slate-900 rounded-2xl p-6 border border-slate-700/50">
                    <label class="text-lg font-semibold text-gray-300">‡ß®. ‡¶≠‡ßü‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <div class="space-y-4 mt-4">
                        <!-- Language Selector -->
                        <div class="relative">
                            <label for="language-selector-btn" class="text-sm font-medium text-gray-400">‡¶≠‡ßü‡ßá‡¶∏‡ßá‡¶∞ ‡¶≠‡¶æ‡¶∑‡¶æ (‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§)</label>
                            <button id="language-selector-btn" class="w-full mt-1 p-3 dark-input rounded-lg text-left transition-all border">
                                <span id="selected-language-text">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</span>
                            </button>
                            <div id="language-dropdown" class="hidden absolute z-10 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-lg">
                                <input type="text" id="language-search" class="w-full p-2 border-b border-slate-700 bg-slate-900 text-gray-200" placeholder="‡¶≠‡¶æ‡¶∑‡¶æ ‡¶¨‡¶æ ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
                                <div id="language-list" class="max-h-64 overflow-y-auto language-list p-1"></div>
                            </div>
                        </div>
                        <!-- Voice Selector -->
                        <div>
                            <label for="voice-select" class="text-sm font-medium text-gray-400">‡¶ï‡¶£‡ßç‡¶† ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                            <select id="voice-select" class="w-full mt-1 p-3 dark-input dark-select rounded-lg focus:ring-2 focus:ring-cyan-500 transition-all border"></select>
                        </div>
                        <div>
                             <label for="speech-style-select" class="text-sm font-medium text-gray-400">‡¶¨‡¶ï‡ßç‡¶§‡ßÉ‡¶§‡¶æ‡¶∞ ‡¶ß‡¶∞‡¶£ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                             <select id="speech-style-select" class="w-full mt-1 p-3 dark-input dark-select rounded-lg focus:ring-2 focus:ring-cyan-500 transition-all border disabled:opacity-50 disabled:bg-slate-800/30 disabled:cursor-not-allowed">
                                <option value="none">‡¶ï‡ßã‡¶®‡ßã‡¶ü‡¶ø‡¶á ‡¶®‡ßü (None)</option>
                                <option value="emotional">‡¶Ü‡¶¨‡ßá‡¶ó‡¶ò‡¶® ‡¶¨‡¶ï‡ßç‡¶§‡ßÉ‡¶§‡¶æ (Emotional)</option>
                                <option value="rhythmic">‡¶∞‡¶ø‡¶¶‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶∞‡ßç‡¶£‡¶®‡¶æ (Rhythmic)</option>
                                <option value="motivational">‡¶Ö‡¶®‡ßÅ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï (Motivational)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-2xl p-6 border border-slate-700/50 flex flex-col flex-grow">
                    <label class="text-lg font-semibold text-gray-300">‡ß©. ‡¶≠‡ßü‡ßá‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</D>
                    <div class="pt-4 flex-grow flex flex-col justify-end">
                        <button id="convert-btn" class="w-full bg-gradient-to-r from-cyan-600 to-teal-600 text-white font-bold py-4 px-6 rounded-lg transition-all transform hover:scale-105 hover:from-cyan-500 hover:to-teal-500 text-lg">
                            ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                    </div>
                     <div id="audio-output" class="hidden mt-6 flex flex-col items-center space-y-4">
                         <div id="loader" class="custom-loader hidden"></div>
                        <audio id="audio-player" controls class="w-full rounded-lg"></audio>
                        <a id="download-link" class="w-full text-center bg-gradient-to-r from-emerald-500 to-green-500 text-white font-bold py-3 px-6 rounded-lg hover:from-emerald-600 hover:to-green-600 transition-transform transform hover:scale-105 shadow-lg hidden">
                            ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (WAV)
                        </a>
                    </div>
                    <div id="error-message" class="text-red-400 text-center font-semibold hidden mt-4"></div>
                </div>
            </div>
        </div>
    </main>

    <footer id="app-footer" class="text-center text-sm text-gray-500 p-4 w-full transition-opacity duration-500">
         <button id="api-settings-btn" class="hover:text-cyan-300 font-semibold">API ‡¶ï‡ßÄ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
         <div id="api-settings-section" class="hidden overflow-hidden transition-all duration-500 max-h-0 max-w-lg mx-auto">
             <div class="mt-2 p-4 border border-slate-700 border-dashed rounded-lg bg-slate-900">
                 <label for="api-key-input" class="text-md font-semibold text-gray-400">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ API ‡¶ï‡ßÄ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:</label>
                 <input type="password" id="api-key-input" class="mt-2 w-full p-2 dark-input rounded-lg focus:ring-2 focus:ring-cyan-500 border">
                 <div class="flex gap-2 mt-3">
                    <button id="save-api-key-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 transition-all">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button id="use-default-key-btn" class="w-full bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-all">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü</button>
                 </div>
                  <p id="api-status" class="text-xs text-center mt-2 font-medium hidden"></p>
             </div>
         </div>
     </footer>

    <!-- Generating Overlay -->
    <div id="generating-overlay" class="generating-overlay fixed inset-0 z-50 flex flex-col items-center justify-center p-8 text-center opacity-0 hidden transition-opacity duration-500">
        <!-- Ad Section -->
        <div class="mb-12 flex flex-col items-center">
             <img src="red.jpg"
                 alt="Advertisement Banner"
                 class="max-w-xl w-full h-auto rounded-lg shadow-lg mb-6 object-cover"
                 style="max-height: 40vh;"
                 onerror="this.onerror=null;this.src='https://placehold.co/800x400/1e293b/475569?text=Advertisement&font=hind-siliguri';">
            <!-- Banner - Accepts image, gif, video (video tag needed for video) -->
            <!-- Placeholder Title for Ad Space -->
            <h2 class="text-3xl font-semibold text-gray-300 mb-4">‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶Ö‡¶´‡¶æ‡¶∞!</h2>
            <!-- Placeholder Button for Ad Space -->
            <button class="bg-gradient-to-r from-pink-500 to-rose-500 text-white font-semibold py-3 px-8 rounded-lg text-lg shadow-lg hover:from-pink-600 hover:to-rose-600 transition-all">
                ‡¶Ü‡¶∞‡¶ì ‡¶ú‡¶æ‡¶®‡ßÅ‡¶®
            </button>
        </div>

        <!-- Generation Progress Section -->
        <div class="flex flex-col items-center">
            <p class="text-2xl font-semibold text-cyan-300 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≠‡ßü‡ßá‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            <div class="sound-wave h-10 flex items-center justify-center mb-4">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <p class="text-sm text-gray-400">‡¶≠‡ßü‡ßá‡¶∏ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Ç‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá</p>
        </div>
    </div>


    <!-- Performance Overview Modal -->
    <div id="overview-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden modal-scale-enter-from">
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden border border-cyan-500/50"> {/* Increased width */}
            <div class="p-4 flex justify-between items-center border-b border-slate-700">
                <h2 class="text-xl font-bold text-white">‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶ì‡¶≠‡¶æ‡¶∞‡¶≠‡¶ø‡¶â</h2>
                <button id="close-modal-overview-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-overview-content" class="p-6 text-gray-300 max-h-[75vh] overflow-y-auto language-list"> {/* Increased height */}
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- Translate Modal -->
    <div id="translate-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden modal-scale-enter-from">
        <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden border border-green-500/50"> {/* Increased width */}
            <div class="p-4 flex justify-between items-center border-b border-slate-700">
                <h2 class="text-xl font-bold text-white">‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <button id="close-modal-translate-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                 <label for="target-language-selector-btn-modal" class="text-md font-semibold text-gray-400">‡¶ï‡ßã‡¶® ‡¶≠‡¶æ‡¶∑‡¶æ‡ßü ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</label>
                <div class="relative">
                    <button id="target-language-selector-btn-modal" class="w-full p-2 text-left dark-input rounded-lg border">
                        <span id="selected-target-language-text-modal">‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø (English (US))</span>
                    </button>
                    <div id="target-language-dropdown-modal" class="hidden absolute z-20 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-lg">
                        <input type="text" id="target-language-search-modal" class="w-full p-2 border-b border-slate-700 bg-slate-900 text-gray-200" placeholder="‡¶≠‡¶æ‡¶∑‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
                        <div id="target-language-list-modal" class="max-h-64 overflow-y-auto language-list p-1"></div> {/* Increased height */}
                    </div>
                </div>
                <button id="apply-translation-btn-modal" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all flex items-center justify-center gap-2 transform hover:scale-102">
                    <span id="apply-translation-loader-modal" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span> ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const appHeader = document.getElementById('app-header');
        const mainContent = document.getElementById('main-content');
        const appFooter = document.getElementById('app-footer');
        const generatingOverlay = document.getElementById('generating-overlay');

        const textInput = document.getElementById('text-input');
        const languageSelectorBtn = document.getElementById('language-selector-btn');
        const selectedLanguageText = document.getElementById('selected-language-text');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageSearch = document.getElementById('language-search');
        const languageList = document.getElementById('language-list');
        const voiceSelect = document.getElementById('voice-select');
        const speechStyleSelect = document.getElementById('speech-style-select');
        const convertBtn = document.getElementById('convert-btn');
        const audioOutput = document.getElementById('audio-output');
        const audioPlayer = document.getElementById('audio-player');
        const downloadLink = document.getElementById('download-link');
        const loader = document.getElementById('loader'); // Loader inside audio output
        const errorMessage = document.getElementById('error-message');
        const charCounter = document.getElementById('char-counter');
        const autoDetectStatus = document.getElementById('auto-detect-status');

        // Gemini Feature Elements
        const changeToneBtn = document.getElementById('change-tone-btn');
        const customToneSection = document.getElementById('custom-tone-section'); // Collapsible section for Tone
        const translateScriptBtn = document.getElementById('translate-script-btn');
        // Translate elements are now in the modal, assigned in initializeApp

        // Modal elements
        const overviewModal = document.getElementById('overview-modal');
        const modalOverviewContent = document.getElementById('modal-overview-content');
        const closeModalOverviewBtn = document.getElementById('close-modal-overview-btn');
        const translateModal = document.getElementById('translate-modal');
        const closeModalTranslateBtn = document.getElementById('close-modal-translate-btn');
        let targetLanguageSelectorBtnModal, selectedTargetLanguageTextModal, targetLanguageDropdownModal, targetLanguageSearchModal, targetLanguageListModal, applyTranslationBtnModal, applyTranslationLoaderModal; // Translate modal elements assigned in init

        // API Key Elements
        const apiSettingsBtn = document.getElementById('api-settings-btn');
        const apiSettingsSection = document.getElementById('api-settings-section');
        let apiKeyInput, saveApiKeyBtn, useDefaultKeyBtn, apiStatus; // Will be assigned in init
        let customToneInput, applyToneBtn, applyToneLoader; // Tone elements assigned in init

        const DEFAULT_API_KEY = 'AIzaSyD5dzqlQV2MwPpxj81rtjOZJ9vVyV14GSM';
        let apiKey = localStorage.getItem('userApiKey') || DEFAULT_API_KEY;
        let selectedLanguage = 'Bengali';
        let selectedTargetLanguage = 'English';
        let selectedTargetLanguageDisplay = '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø (English (US))'; // Added for display consistency
        let debounceTimeout;

        const MAX_CHARS = 4500;
        const MIN_LOADING_TIME = 5000; // Minimum 5 seconds loading screen

        // Data (Languages and Voices remain the same)
        const allLanguages = [
            { code: 'Bengali', name: 'Bengali', bnName: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', countries: ['Bangladesh', 'India'], nativeTo: ['Bangladesh'] },
            { code: 'Hindi', name: 'Hindi', bnName: '‡¶π‡¶ø‡¶®‡ßç‡¶¶‡¶ø', countries: ['India', 'Fiji', 'Nepal'], nativeTo: ['India'] },
            { code: 'Urdu', name: 'Urdu', bnName: '‡¶â‡¶∞‡ßç‡¶¶‡ßÅ', countries: ['Pakistan', 'India'], nativeTo: ['Pakistan'] },
            { code: 'English', name: 'English (US)', bnName: '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø (US)', countries: ['USA', 'United States', 'UK', 'United Kingdom', 'Canada', 'Australia', 'India', 'Nigeria'], nativeTo: ['USA', 'United States', 'UK', 'United Kingdom', 'Canada', 'Australia'] },
            { code: 'ar-EG', name: 'Arabic (Egypt)', bnName: '‡¶Ü‡¶∞‡¶¨‡¶ø (‡¶Æ‡¶ø‡¶∂‡¶∞)', countries: ['Egypt', 'Sudan'], nativeTo: ['Egypt'] },
            { code: 'de-DE', name: 'German', bnName: '‡¶ú‡¶æ‡¶∞‡ßç‡¶Æ‡¶æ‡¶®', countries: ['Germany', 'Austria', 'Switzerland'], nativeTo: ['Germany', 'Austria'] },
            { code: 'es-US', name: 'Spanish (US)', bnName: '‡¶∏‡ßç‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶∂ (US)', countries: ['Spain', 'Mexico', 'USA', 'United States', 'Colombia', 'Argentina'], nativeTo: ['Spain', 'Mexico', 'Colombia', 'Argentina'] },
            { code: 'fr-FR', name: 'French', bnName: '‡¶´‡¶∞‡¶æ‡¶∏‡¶ø', countries: ['France', 'Canada', 'Belgium', 'Switzerland'], nativeTo: ['France'] },
            { code: 'id-ID', name: 'Indonesian', bnName: '‡¶á‡¶®‡ßç‡¶¶‡ßã‡¶®‡ßá‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶®', countries: ['Indonesia'], nativeTo: ['Indonesia'] },
            { code: 'it-IT', name: 'Italian', bnName: '‡¶á‡¶§‡¶æ‡¶≤‡ßÄ‡¶Ø‡¶º', countries: ['Italy', 'Switzerland'], nativeTo: ['Italy'] },
            { code: 'ja-JP', name: 'Japanese', bnName: '‡¶ú‡¶æ‡¶™‡¶æ‡¶®‡¶ø', countries: ['Japan'], nativeTo: ['Japan'] },
            { code: 'ko-KR', name: 'Korean', bnName: '‡¶ï‡ßã‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶®', countries: ['South Korea', 'North Korea'], nativeTo: ['South Korea', 'North Korea'] },
            { code: 'pt-BR', name: 'Portuguese (Brazil)', bnName: '‡¶™‡¶∞‡ßç‡¶§‡ßÅ‡¶ó‡¶ø‡¶ú (‡¶¨‡ßç‡¶∞‡¶æ‡¶ú‡¶ø‡¶≤)', countries: ['Brazil', 'Portugal'], nativeTo: ['Brazil', 'Portugal'] },
            { code: 'ru-RU', name: 'Russian', bnName: '‡¶∞‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶®', countries: ['Russia'], nativeTo: ['Russia'] },
            { code: 'nl-NL', name: 'Dutch', bnName: '‡¶°‡¶æ‡¶ö', countries: ['Netherlands', 'Belgium'], nativeTo: ['Netherlands'] },
            { code: 'pl-PL', name: 'Polish', bnName: '‡¶™‡ßã‡¶≤‡¶ø‡¶∂', countries: ['Poland'], nativeTo: ['Poland'] },
            { code: 'tr-TR', name: 'Turkish', bnName: '‡¶§‡ßÅ‡¶∞‡ßç‡¶ï‡¶ø', countries: ['Turkey'], nativeTo: ['Turkey'] },
            { code: 'vi-VN', name: 'Vietnamese', bnName: '‡¶≠‡¶ø‡¶Ø‡¶º‡ßá‡¶§‡¶®‡¶æ‡¶Æ‡ßÄ', countries: ['Vietnam'], nativeTo: ['Vietnam'] },
            { code: 'fi-FI', name: 'Finnish', bnName: '‡¶´‡¶ø‡¶®‡¶ø‡¶∂', countries: ['Finland'], nativeTo: ['Finland'] },
        ];
        const voicesByLanguage = {
            'Default': [{ value: 'Puck', text: 'Energetic Voice' }, { value: 'Charon', text: 'Informative Voice' }],
            'Bengali': [{ value: 'Kore', text: '‡¶ó‡¶Æ‡ßç‡¶≠‡ßÄ‡¶∞ ‡¶ò‡ßã‡¶∑‡¶ï' }, { value: 'Puck', text: '‡¶â‡ßé‡¶∏‡¶æ‡¶π‡¶ø‡¶§ ‡¶ó‡¶≤‡ßç‡¶™‡¶ï‡¶æ‡¶∞' }, { value: 'Charon', text: '‡¶§‡¶•‡ßç‡¶Ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡ßç‡¶∞‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï' }, { value: 'Orus', text: '‡¶¶‡ßÉ‡ßù ‡¶®‡ßá‡¶§‡¶æ' }, { value: 'Algenib', text: '‡¶™‡¶∞‡¶ø‡¶™‡¶ï‡ßç‡¶ï ‡¶ì ‡¶ó‡¶Æ‡ßç‡¶≠‡ßÄ‡¶∞' }],
            'English': [{ value: 'Puck', text: 'Energetic Storyteller' }, { value: 'Charon', text: 'Informative Instructor' }, { value: 'Kore', text: 'Authoritative Announcer' }],
            'Hindi': [{ value: 'Kore', text: '‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï ‡§â‡§¶‡•ç‡§ò‡•ã‡§∑‡§ï' }, { value: 'Puck', text: '‡§ä‡§∞‡•ç‡§ú‡§æ‡§µ‡§æ‡§® ‡§ï‡§•‡§æ‡§µ‡§æ‡§ö‡§ï' }, { value: 'Charon', text: '‡§∏‡•Ç‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï' }],
            'Urdu': [{ value: 'Algenib', text: 'ÿ≥ŸÜÿ¨€åÿØ€Å ‡¶ò‡ßã‡¶∑⁄©' }, { value: 'Orus', text: 'Ÿæÿ±ÿßÿπÿ™ŸÖÿßÿØ ÿ±€ÅŸÜŸÖÿß' }, { value: 'Charon', text: 'ŸÖÿπŸÑŸàŸÖÿßÿ™€å ÿßŸÜÿ≥Ÿπÿ±€å⁄©Ÿπÿ±' }],
            'de-DE': [{ value: 'Kore', text: 'Autorit√§re Ansager' }, { value: 'Charon', text: 'Informativer Sprecher' }],
            'it-IT': [{ value: 'Puck', text: 'Narratore Energico' }, { value: 'Enceladus', text: 'Voce Calma e Ariosa' }],
            'fi-FI': [{ value: 'Charon', text: 'Informatiivinen kertoja' }, { value: 'Kore', text: 'Auktoriteettinen √§√§ni' }]
        };
         const stylePrompts = {
            none: "",
            emotional: "Say in an emotional and strong speaking style: ",
            rhythmic: "Recite the following in a rhythmic and fluent style: ",
            motivational: "Speak in a motivational and encouraging tone: "
        };

        // --- UI Creation Functions ---

        function populateLanguageList(listElement, searchElement, callback) {
            listElement.innerHTML = '';
            const filter = searchElement.value.toLowerCase();
            let filteredLanguages = allLanguages.filter(lang => {
                if (!filter) return true;
                if (lang.name.toLowerCase().includes(filter) || lang.bnName.toLowerCase().includes(filter)) return true;
                return lang.countries.some(country => country.toLowerCase().includes(filter));
            });
            filteredLanguages.sort((a, b) => {
                const aIsNativeMatch = a.nativeTo.some(country => country.toLowerCase().includes(filter));
                const bIsNativeMatch = b.nativeTo.some(country => country.toLowerCase().includes(filter));
                if (aIsNativeMatch && !bIsNativeMatch) return -1;
                if (!aIsNativeMatch && bIsNativeMatch) return 1;
                return a.bnName.localeCompare(b.bnName);
            });
            filteredLanguages.forEach(lang => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'block p-2 hover:bg-slate-700/80 rounded';
                item.textContent = `${lang.bnName} (${lang.name})`;
                item.dataset.code = lang.code;
                item.dataset.name = lang.name;
                item.dataset.displayName = `${lang.bnName} (${lang.name})`;
                item.addEventListener('click', (e) => callback(e, item));
                listElement.appendChild(item);
            });
        }

        function updateVoiceOptions(language) {
            const voices = voicesByLanguage[language] || voicesByLanguage['Default'];
            voiceSelect.innerHTML = '';
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.value;
                option.textContent = voice.text;
                voiceSelect.appendChild(option);
            });
        }

        // --- Initialize ---
        function initializeApp() {
            // Assign dynamic elements for Tone Section
            customToneInput = document.getElementById('custom-tone-input');
            applyToneBtn = document.getElementById('apply-tone-btn');
            applyToneLoader = document.getElementById('apply-tone-loader');

            // Assign dynamic elements for Translate Modal
            targetLanguageSelectorBtnModal = document.getElementById('target-language-selector-btn-modal');
            selectedTargetLanguageTextModal = document.getElementById('selected-target-language-text-modal');
            targetLanguageDropdownModal = document.getElementById('target-language-dropdown-modal');
            targetLanguageSearchModal = document.getElementById('target-language-search-modal');
            targetLanguageListModal = document.getElementById('target-language-list-modal');
            applyTranslationBtnModal = document.getElementById('apply-translation-btn-modal');
            applyTranslationLoaderModal = document.getElementById('apply-translation-loader-modal');

            // Assign dynamic elements for API Settings
            apiKeyInput = document.getElementById('api-key-input');
            saveApiKeyBtn = document.getElementById('save-api-key-btn');
            useDefaultKeyBtn = document.getElementById('use-default-key-btn');
            apiStatus = document.getElementById('api-status');

            // Add event listeners
            applyToneBtn.addEventListener('click', applyTone);
            applyTranslationBtnModal.addEventListener('click', applyTranslation); // Use modal button
            saveApiKeyBtn.addEventListener('click', saveApiKey);
            useDefaultKeyBtn.addEventListener('click', useDefaultApiKey);

             populateLanguageList(targetLanguageListModal, targetLanguageSearchModal, (e, item) => { // Use modal list/search
                e.preventDefault();
                selectedTargetLanguage = item.dataset.name;
                selectedTargetLanguageDisplay = item.dataset.displayName; // Store display name
                selectedTargetLanguageTextModal.textContent = item.dataset.displayName; // Update modal text
                targetLanguageDropdownModal.classList.add('hidden');
            });
            targetLanguageSelectorBtnModal.addEventListener('click', () => { // Use modal button
                targetLanguageDropdownModal.classList.toggle('hidden');
            });
             targetLanguageSearchModal.addEventListener('input', () => populateLanguageList(targetLanguageListModal, targetLanguageSearchModal, (e, item) => { // Search listener for modal
                e.preventDefault();
                selectedTargetLanguage = item.dataset.name;
                selectedTargetLanguageDisplay = item.dataset.displayName;
                selectedTargetLanguageTextModal.textContent = item.dataset.displayName;
                targetLanguageDropdownModal.classList.add('hidden');
            }));

            apiKeyInput.value = localStorage.getItem('userApiKey') || '';

            populateLanguageList(languageList, languageSearch, (e, item) => {
                e.preventDefault();
                selectedLanguage = item.dataset.code;
                selectedLanguageText.textContent = item.dataset.displayName;
                languageDropdown.classList.add('hidden');
                updateVoiceOptions(selectedLanguage);
            });
            updateVoiceOptions(selectedLanguage);
        }

        initializeApp();

        // --- Event Listeners ---
        languageSelectorBtn.addEventListener('click', () => languageDropdown.classList.toggle('hidden'));
        languageSearch.addEventListener('input', () => populateLanguageList(languageList, languageSearch, (e, item) => {
            e.preventDefault();
            selectedLanguage = item.dataset.code;
            selectedLanguageText.textContent = item.dataset.displayName;
            languageDropdown.classList.add('hidden');
            updateVoiceOptions(selectedLanguage);
        }));

        document.addEventListener('click', (e) => {
            if (!languageSelectorBtn.contains(e.target) && !languageDropdown.contains(e.target)) languageDropdown.classList.add('hidden');
            // Close translate modal dropdown if click outside
            if (targetLanguageSelectorBtnModal && targetLanguageDropdownModal && !targetLanguageSelectorBtnModal.contains(e.target) && !targetLanguageDropdownModal.contains(e.target)) {
                 targetLanguageDropdownModal.classList.add('hidden');
            }
        });

        textInput.addEventListener('input', () => {
            const charCount = textInput.value.length;
            charCounter.textContent = `${charCount} / ${MAX_CHARS}`;
            charCounter.classList.toggle('text-red-400', charCount > MAX_CHARS);

            const hasText = textInput.value.trim().length > 0;
            changeToneBtn.classList.toggle('hidden', !hasText);
            translateScriptBtn.classList.toggle('hidden', !hasText);
            if(!hasText) {
                 toggleCollapsibleSection(null); // Hide tone section if text is cleared
            }

            clearTimeout(debounceTimeout);
            if (hasText && textInput.value.trim().length > 20) {
                 autoDetectStatus.classList.remove('opacity-0');
                debounceTimeout = setTimeout(() => {
                    detectLanguage(textInput.value);
                }, 1500);
            } else {
                autoDetectStatus.classList.add('opacity-0');
            }
        });

        apiSettingsBtn.addEventListener('click', () => {
             const isHidden = apiSettingsSection.classList.contains('hidden');
             apiSettingsSection.classList.toggle('hidden');
             setTimeout(() => {
                apiSettingsSection.classList.toggle('max-h-0', !isHidden);
                // Adjust height dynamically based on content or use a fixed height
                apiSettingsSection.style.maxHeight = isHidden ? '200px' : '0px';
             }, 10);
        });

        function saveApiKey() {
            if (apiKeyInput) {
                const newKey = apiKeyInput.value.trim();
                if (newKey) {
                    localStorage.setItem('userApiKey', newKey);
                    apiKey = newKey;
                    showApiStatus('API ‡¶ï‡ßÄ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                } else {
                    showApiStatus('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß API ‡¶ï‡ßÄ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§', true);
                }
            }
        }

        function useDefaultApiKey() {
            localStorage.removeItem('userApiKey');
            apiKey = DEFAULT_API_KEY;
            if(apiKeyInput) apiKeyInput.value = '';
            showApiStatus('‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü API ‡¶ï‡ßÄ ‡¶è‡¶ñ‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡•§');
        }

        // Simplified toggle for only the Tone section now
        function toggleCollapsibleSection(sectionToToggle) {
             if (sectionToToggle === customToneSection) {
                 const isHidden = customToneSection.classList.contains('hidden');
                 customToneSection.classList.toggle('hidden');
                 setTimeout(() => {
                    customToneSection.classList.toggle('max-h-0', !isHidden);
                    customToneSection.style.maxHeight = isHidden ? '200px' : '0px';
                 }, 10);
                 speechStyleSelect.disabled = isHidden; // Disable speech style only if tone section is open
             } else {
                 // If hiding all (passed null)
                  if (!customToneSection.classList.contains('hidden')) {
                     customToneSection.classList.add('max-h-0');
                     setTimeout(() => customToneSection.classList.add('hidden'), 300);
                 }
                 speechStyleSelect.disabled = false;
             }
        }

        changeToneBtn.addEventListener('click', () => toggleCollapsibleSection(customToneSection));
        translateScriptBtn.addEventListener('click', () => { // Open translate modal
            hideError(); // Clear any previous errors
            selectedTargetLanguageTextModal.textContent = selectedTargetLanguageDisplay; // Ensure modal shows current selection
            translateModal.classList.remove('hidden');
            setTimeout(() => translateModal.classList.remove('modal-scale-enter-from'), 10);
        });

        // Modal Logic
        closeModalOverviewBtn.addEventListener('click', () => {
            overviewModal.classList.add('modal-scale-leave-to');
            setTimeout(() => {
                overviewModal.classList.add('hidden');
                overviewModal.classList.remove('modal-scale-leave-to');
            }, 300);
        });

        overviewModal.addEventListener('click', (e) => {
            if (e.target === overviewModal) {
                closeModalOverviewBtn.click();
            }
        });

        closeModalTranslateBtn.addEventListener('click', () => {
            translateModal.classList.add('modal-scale-leave-to');
            setTimeout(() => {
                translateModal.classList.add('hidden');
                translateModal.classList.remove('modal-scale-leave-to');
            }, 300);
        });

        translateModal.addEventListener('click', (e) => {
             if (e.target === translateModal) {
                closeModalTranslateBtn.click();
            }
        });


        function showOverviewModal(overviewText) {
            modalOverviewContent.textContent = overviewText;
            overviewModal.classList.remove('hidden');
            setTimeout(() => overviewModal.classList.remove('modal-scale-enter-from'), 10);
        }

        // --- Main Logic ---
        async function fetchWithRetry(url, options, maxRetries = 3) {
            let delay = 1000; // Initial delay 1 second
            let lastError = null; // Store last error

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);

                    if (response.status === 429) { // Specific handling for 429
                        const errorText = await response.text();
                        console.warn("API Rate Limit Exceeded:", errorText);
                        let retryDelaySeconds = delay / 1000; // Default delay
                        try {
                            const errorJson = JSON.parse(errorText);
                            const retryInfo = errorJson.error?.details?.find(d => d['@type'] === 'type.googleapis.com/google.rpc.RetryInfo');
                            if (retryInfo?.retryDelay) {
                                // Extract seconds from duration string like "55s"
                                const match = retryInfo.retryDelay.match(/(\d+)s/);
                                if (match && match[1]) {
                                    retryDelaySeconds = parseInt(match[1], 10);
                                    delay = retryDelaySeconds * 1000; // Update delay for the wait
                                }
                            }
                        } catch (parseErr) {
                             console.error("Could not parse 429 error details:", parseErr);
                        }
                         showError(`API ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ${retryDelaySeconds} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... (${i+1}/${maxRetries})‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ API ‡¶ï‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
                         lastError = new Error('rate_limit'); // Special error for rate limit
                         throw lastError; // Go to catch block for retry delay
                    }

                    if (response.status === 503) {
                         showError(`‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶∏‡ßç‡¶§‡•§ ${delay/1000} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... (${i+1}/${maxRetries})`);
                         lastError = new Error('overloaded');
                         throw lastError;
                    }
                     if (!response.ok) { // Catch other errors too
                        const errorText = await response.text();
                        console.error("API Error Response:", errorText);
                        try {
                            const errorJson = JSON.parse(errorText);
                            lastError = new Error(errorJson.error?.message || `API Error: ${response.status}`);
                        } catch (parseError) {
                            lastError = new Error(`API Error: ${response.status} - ${errorText.substring(0, 100)}`);
                        }
                         throw lastError;
                    }
                    hideError(); // Clear error on success
                    return response; // Success
                } catch (error) {
                     lastError = error; // Update last error
                     if (i === maxRetries - 1) {
                        console.error(`Final attempt failed after ${maxRetries} retries.`);
                        throw lastError; // Throw final error if max retries reached
                    }
                    console.warn(`Attempt ${i+1} failed. Retrying in ${delay/1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff only for non-429 errors or if 429 parsing failed
                }
            }
             // This part should theoretically not be reached if error handling above is correct
            throw lastError || new Error('‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ì API ‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }


        async function detectLanguage(text) {
            languageSelectorBtn.classList.add('ring-2', 'ring-yellow-500');
            autoDetectStatus.classList.remove('opacity-0');
            try {
                const detectPrompt = `Identify the primary language of the following text. Respond with only the English name of the language from this list: [Bengali, Hindi, Urdu, English (US), Arabic (Egypt), German, Spanish (US), French, Indonesian, Italian, Japanese, Korean, Portuguese (Brazil), Russian, Dutch, Polish, Turkish, Vietnamese, Finnish]. Text: "${text.substring(0, 250).replace(/"/g, '\\"')}"`;
                let detectedLanguageName = await callTextGenerationAPI(detectPrompt);
                detectedLanguageName = detectedLanguageName.trim();

                let languageObject = allLanguages.find(lang => lang.name === detectedLanguageName || lang.code === detectedLanguageName) || allLanguages.find(lang => lang.name.includes(detectedLanguageName));

                if (languageObject) {
                    selectedLanguage = languageObject.code;
                    selectedLanguageText.textContent = `${languageObject.bnName} (${languageObject.name})`;
                    updateVoiceOptions(selectedLanguage);
                    languageSelectorBtn.classList.replace('ring-yellow-500', 'ring-green-500');
                } else {
                    console.warn("Detected language not in known list:", detectedLanguageName);
                    languageSelectorBtn.classList.replace('ring-yellow-500', 'ring-red-500');
                }
            } catch (error) {
                console.error("Language detection failed:", error);
                languageSelectorBtn.classList.replace('ring-yellow-500', 'ring-red-500');
                 showError("‡¶≠‡¶æ‡¶∑‡¶æ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message); // Show error to user
            } finally {
                setTimeout(() => {
                    languageSelectorBtn.classList.remove('ring-2', 'ring-yellow-500', 'ring-green-500', 'ring-red-500');
                    autoDetectStatus.classList.add('opacity-0');
                }, 2000);
            }
        }

        async function applyTone() {
            const rawText = textInput.value.trim();
            const customTone = customToneInput.value.trim();

            if (!rawText) return showError('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');
            hideError();
            applyToneLoader.classList.remove('hidden');
            applyToneBtn.disabled = true;

            try {
                const engineerPrompt = `You are a Universal Maestro of Vocal Expression. Your mission is to transform ANY script in ANY language into a performance-ready annotated script.
**Critical Mandate:** ALL annotations MUST be in **concise, simple English**.
**Core Directives:**
1. **Detect Language:** Instantly detect the script's language and respect its nuances.
2. **Preserve Original:** **DO NOT** alter the user‚Äôs original words. Only add English annotations in parentheses.
3. **Director's Notes (English):** Guide pacing, emotion, dynamics, breath, and cultural sensitivity.
4. **Emotional Arc:** If no tone is specified, apply a default arc (solemn -> intense -> tender -> resolved). Prioritize user's tone if provided.
5. **Output Format:** Return the annotated script. Then, on a new line, write "---" followed by a short "Performance Overview" in the script's original language.
6. **FINAL CHECKLIST (MANDATORY):** Are ALL original words 100% intact? Are ALL notes in English? Does it feel like a live performance?
---
**User's Request:**
* **Desired Tone:** "${customTone || 'Default Emotional Arc'}"
* **Script to Annotate:** "${rawText.replace(/"/g, '\\"')}"`;
                const fullResponse = await callTextGenerationAPI(engineerPrompt);
                const parts = fullResponse.split('---');
                textInput.value = parts[0].trim();
                if (parts[1]) {
                    showOverviewModal(parts[1].trim());
                }
                 toggleCollapsibleSection(null); // Close the section after applying
            } catch (error) {
                showError('‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ' + error.message);
            } finally {
                applyToneLoader.classList.add('hidden');
                applyToneBtn.disabled = false;
            }
        }

        async function applyTranslation() {
            const rawText = textInput.value.trim();

            if (!rawText) return showError('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');
            hideError();
            applyTranslationLoaderModal.classList.remove('hidden');
            applyTranslationBtnModal.disabled = true;

            try {
                const translatePrompt = `You are an expert linguist. Translate the following text into ${selectedTargetLanguage}. Preserve the original meaning, nuances, and tone perfectly. Respond ONLY with the translated text. Text to Translate: "${rawText.replace(/"/g, '\\"')}"`;
                textInput.value = await callTextGenerationAPI(translatePrompt);
                const targetLangObject = allLanguages.find(lang => lang.name === selectedTargetLanguage);
                if (targetLangObject) {
                    selectedLanguage = targetLangObject.code;
                    selectedLanguageText.textContent = targetLangObject.bnName + ` (${targetLangObject.name})`;
                    updateVoiceOptions(selectedLanguage);
                }
                closeModalTranslateBtn.click(); // Close modal on success
            } catch (error) {
                showError('‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ' + error.message);
            } finally {
                applyTranslationLoaderModal.classList.add('hidden');
                applyTranslationBtnModal.disabled = false;
            }
        }

        async function callTextGenerationAPI(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const requestBody = { contents: [{ parts: [{ text: prompt }] }] };
            // Use fetchWithRetry for text generation as well
            const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            // Error handling is now inside fetchWithRetry
            const result = await response.json();
             if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts || !result.candidates[0].content.parts[0].text) {
                console.error("Unexpected API response structure:", result);
                throw new Error("API ‡¶•‡ßá‡¶ï‡ßá ‡¶Ö‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶§ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶è‡¶∏‡ßá‡¶õ‡ßá‡•§");
            }
            return result.candidates[0].content.parts[0].text;
        }

        convertBtn.addEventListener('click', async () => {
            const rawText = textInput.value.trim();
            if (rawText.length > MAX_CHARS) return showError(`‡¶≤‡ßá‡¶ñ‡¶æ‡¶ü‡¶ø ${MAX_CHARS} ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§`);
            if (!rawText) return showError('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');

            hideError();
            audioOutput.classList.add('hidden'); // Hide previous audio
            convertBtn.disabled = true; // Disable button immediately

            // Start showing the generating overlay
            appHeader.classList.add('opacity-0', 'pointer-events-none');
            mainContent.classList.add('opacity-0', 'pointer-events-none');
            appFooter.classList.add('opacity-0', 'pointer-events-none');
            generatingOverlay.classList.remove('hidden');
            setTimeout(() => generatingOverlay.classList.remove('opacity-0'), 10);

            const startTime = performance.now();
            let success = false;
            let audioUrl = null;
            let wavBlob = null;
            let errorOccurred = null;


            try {
                let textToConvert = rawText.split('---')[0].trim(); // Use only script part
                const selectedStyle = speechStyleSelect.value;
                // Apply style prompt only if the tone section is closed AND style is not 'none'
                if (selectedStyle !== 'none' && customToneSection.classList.contains('hidden')) {
                    // Find the language name for the prompt
                     const currentLangObj = allLanguages.find(l => l.code === selectedLanguage) || {};
                     const langNameForPrompt = currentLangObj.name || selectedLanguage; // Fallback to code if name not found
                     let promptPrefix = '';
                      // Use English prompts for better compatibility as requested earlier
                     switch(selectedStyle) {
                         case 'emotional': promptPrefix = `Say in an emotional and strong speaking style: `; break;
                         case 'rhythmic': promptPrefix = `Recite the following in a rhythmic and fluent style: `; break;
                         case 'motivational': promptPrefix = `Speak in a motivational and encouraging tone: `; break;
                     }
                     textToConvert = promptPrefix + textToConvert;
                }

                const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const requestBody = { model: "gemini-2.5-flash-preview-tts", contents: [{ parts: [{ text: textToConvert }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceSelect.value } } } } };

                // Use fetchWithRetry for TTS call
                const response = await fetchWithRetry(ttsApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                // Error handling is inside fetchWithRetry now

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType?.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)?.[1] || 24000, 10);
                    const pcmDataBytes = base64ToArrayBuffer(audioData); // Get Uint8Array
                    const pcmDataInt16 = new Int16Array(pcmDataBytes.buffer); // Convert buffer to Int16Array
                    wavBlob = pcmToWav(pcmDataInt16, sampleRate);
                    audioUrl = URL.createObjectURL(wavBlob);
                    success = true; // Mark as success
                } else {
                     console.error("Unexpected TTS API response structure:", result);
                    throw new Error('API ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§');
                }
            } catch (error) {
                // errorOccurred = error.message || '‡¶ï‡¶£‡ßç‡¶† ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§';
                 // Don't override the specific error shown by fetchWithRetry for quota issues
                 if (!errorMessage.textContent.includes('API ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶π‡ßü‡ßá‡¶õ‡ßá')) {
                    errorOccurred = error.message || '‡¶ï‡¶£‡ßç‡¶† ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§';
                 } else {
                     errorOccurred = errorMessage.textContent; // Keep the quota message
                 }
            } finally {
                const endTime = performance.now();
                const elapsedTime = endTime - startTime;
                const remainingTime = Math.max(0, MIN_LOADING_TIME - elapsedTime);

                // Wait for minimum display time
                setTimeout(() => {
                    // Hide generating overlay
                    generatingOverlay.classList.add('opacity-0');
                    setTimeout(() => generatingOverlay.classList.add('hidden'), 500); // Wait for fade out

                    // Show main content
                    appHeader.classList.remove('opacity-0', 'pointer-events-none');
                    mainContent.classList.remove('opacity-0', 'pointer-events-none');
                    appFooter.classList.remove('opacity-0', 'pointer-events-none');

                    // Handle result
                    if (success && audioUrl) {
                        audioOutput.classList.remove('hidden');
                        loader.classList.add('hidden'); // Ensure loader inside audio output is hidden
                        audioPlayer.src = audioUrl;
                        audioPlayer.classList.remove('hidden');
                        downloadLink.href = audioUrl;
                        downloadLink.classList.remove('hidden');
                    } else {
                        // Show error only if it wasn't a quota message already shown
                         if (errorOccurred && !errorOccurred.includes('API ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶Ö‡¶§‡¶ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶π‡ßü‡ßá‡¶õ‡ßá')) {
                             showError(errorOccurred);
                         } else if (errorOccurred) {
                              showError(errorOccurred); // Still show the quota message
                         }
                        audioOutput.classList.add('hidden'); // Hide audio section on error
                    }
                    convertBtn.disabled = false; // Re-enable button
                }, remainingTime);
            }
        });

        // --- Helper Functions ---
        function showApiStatus(message, isError = false) {
            const statusEl = document.getElementById('api-status');
            if(statusEl) {
                statusEl.textContent = message;
                statusEl.className = `text-xs text-center mt-2 font-medium ${isError ? 'text-red-400' : 'text-green-400'}`;
                statusEl.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('hidden'), 3000);
            }
        }
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes; // Return Uint8Array directly
        }
        function pcmToWav(pcmData, sampleRate) { // Expects Int16Array
            const dataSize = pcmData.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, 1, true); // numChannels (mono)
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * 2, true); // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true); // BlockAlign (NumChannels * BitsPerSample/8)
            view.setUint16(34, 16, true); // BitsPerSample (16)
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true); // Subchunk2Size
            // Write PCM data from Int16Array
            new Int16Array(buffer, 44).set(pcmData);
            return new Blob([view], { type: 'audio/wav' });
        }
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
        }
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        function hideError() {
            errorMessage.classList.add('hidden');
        }
    </script>
</body>
</html>

        @keyframes bounceDot3 {
            0%, 40%, 80%, 100% { transform: translateY(0); opacity: 1; }
            60% { transform: translateY(-5px); opacity: 0.5; }
        }
        /* Apply animations to dots with different delays */
        .animate-bounce-dot-1 {
            animation: bounceDot1 1.4s infinite ease-in-out;
        }
        .animate-bounce-dot-2 {
            animation: bounceDot2 1.4s infinite ease-in-out;
        }
        .animate-bounce-dot-3 {
            animation: bounceDot3 1.4s infinite ease-in-out;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-50 font-inter antialiased">
    <!-- Header section with soft gradient, subtle shadow, and rounded bottom corners -->
    <header class="bg-gradient-to-r from-emerald-400 to-emerald-500 text-white p-4 shadow-lg rounded-b-xl flex flex-col sm:flex-row justify-between items-center z-10">
        <!-- Shopping Assistant Logo and Title -->
        <div class="flex items-center space-x-2 mb-2 sm:mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-bag text-white">
                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/>
                <path d="M3 6h18"/>
                <path d="M16 10a4 4 0 0 1-8 0"/>
            </svg>
            <h1 class="text-2xl sm:text-3xl font-bold tracking-wide text-white">Shopping Assistant</h1>
        </div>

        <!-- Right-aligned buttons -->
        <div class="flex items-center space-x-2 flex-wrap justify-center sm:justify-end">
            <!-- Product Recommendation Icon -->
            <button
                id="recommendProductButton"
                class="p-2 sm:p-3 bg-white text-emerald-700 rounded-full shadow-md hover:bg-emerald-50 transition-all duration-300 active:scale-95 text-sm font-semibold flex items-center justify-center border border-emerald-200"
                title="Get Product Recommendation"
            >
                <!-- Award icon from Lucide -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-award"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 22 12 18 17 22 15.79 13.89"/></svg>
            </button>

            <!-- Refresh Button -->
            <button
                id="refreshChatButton"
                class="px-3 py-2 sm:px-4 sm:py-2 bg-white text-emerald-700 rounded-full shadow-md hover:bg-emerald-50 transition-all duration-300 active:scale-95 text-sm font-semibold flex items-center space-x-1 border border-emerald-200"
                title="Start a new chat"
            >
                <!-- RefreshCcw icon from Lucide -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.76 2.75L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.76-2.75L21 16"/><path d="M21 21v-5h-5"/></svg>
                <span>Refresh</span>
            </button>
        </div>
    </header>

    <!-- Chat Window - main content area for messages -->
    <div
        id="chatWindow"
        class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 custom-scrollbar relative"
        style="scroll-behavior: smooth;"
    >
        <!-- Watermark -->
        <div id="watermark" class="absolute inset-0 flex items-center justify-center pointer-events-none z-0 opacity-20 text-gray-300 text-5xl font-bold uppercase tracking-widest">
            Shopping Assistant
        </div>
        <!-- Chat messages will be dynamically inserted here -->
    </div>

    <!-- Message Input Area -->
    <div class="p-4 bg-white border-t border-gray-200 shadow-lg rounded-t-xl flex items-center sticky bottom-0 z-10">
        <input
            type="text"
            id="messageInput"
            class="flex-1 p-3 md:p-4 border border-gray-300 bg-white text-gray-800 rounded-full focus:outline-none focus:ring-2 focus:ring-emerald-400 placeholder-gray-500 text-base transition-all duration-200"
            placeholder="Type your message..."
        />
        <!-- Send button with icon -->
        <button
            id="sendMessageButton"
            class="ml-3 p-3 md:p-4 rounded-full bg-emerald-500 text-white flex items-center justify-center transition-all duration-300 hover:bg-emerald-600 hover:shadow-md active:scale-95 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed"
            title="Send message"
        >
            <!-- Send icon (Right Arrow) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </button>
    </div>

    <!-- Product Recommendation Modal -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto relative">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-gray-800">Recommended Products</h2>
                <button id="closeModalButton" class="text-gray-500 hover:text-gray-800 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div id="productsList" class="space-y-4">
                <!-- Products will be loaded here -->
            </div>
            <!-- Discount contact message area -->
            <div id="discountMessageArea" class="mt-4 p-3 bg-emerald-50 text-emerald-800 rounded-lg hidden">
                For more detailed information and exclusive discounts, feel free to contact us at <a href="mailto:alshakil.bd03@gmail.com" class="font-semibold underline">alshakil.bd03@gmail.com</a>.
            </div>
        </div>
    </div>

    <script>
        // --- SIMULATED THIRD-PARTY PRODUCT DATA SERVICE ---
        const mockProductDataService = async (query = '') => {
            await new Promise(resolve => setTimeout(resolve, 800));

            const allProducts = [
                {
                    id: 'laptop-a',
                    name: 'UltraBook Pro 13',
                    category: 'Laptop',
                    price: 1200,
                    features: ['Intel i7', '16GB RAM', '512GB SSD', '13-inch Retina Display', 'Lightweight'],
                    reviews: { average: 4.7, count: 850 },
                    pros: ['Extremely portable', 'High performance for everyday tasks', 'Excellent display'],
                    cons: ['Higher price point', 'Limited ports', 'Not ideal for heavy gaming'],
                    description: 'A premium lightweight laptop perfect for professionals and students on the go.'
                },
                {
                    id: 'laptop-b',
                    name: 'Gaming Beast 15',
                    category: 'Laptop',
                    price: 1500,
                    features: ['AMD Ryzen 7', '32GB RAM', '1TB SSD', 'RTX 3060', '15-inch 144Hz Display'],
                    reviews: { average: 4.5, count: 1200 },
                    pros: ['Powerful gaming performance', 'Large, fast display', 'Ample storage and RAM'],
                    cons: ['Heavy and bulky', 'Shorter battery life', 'Can run hot under load'],
                    description: 'Unleash your gaming potential with this high-performance gaming laptop.'
                },
                {
                    id: 'headphone-x',
                    name: 'Noise Cancelling Headphones X',
                    category: 'Headphones',
                    price: 350,
                    features: ['Active Noise Cancellation', '40-hour Battery', 'Comfortable Over-Ear', 'Bluetooth 5.2'],
                    reviews: { average: 4.8, count: 2100 },
                    pros: ['Superior noise cancellation', 'Long battery life', 'Very comfortable for long wear'],
                    cons: ['Premium price', 'Bass can be overpowering for some', 'Not foldable'],
                    description: 'Immerse yourself in pure sound with industry-leading noise cancellation.'
                },
                {
                    id: 'headphone-y',
                    name: 'Sport Earbuds Y',
                    category: 'Headphones',
                    price: 120,
                    features: ['Sweatproof', 'Secure Fit', '8-hour Battery (plus case)', 'Bluetooth 5.0'],
                    reviews: { average: 4.3, count: 950 },
                    pros: ['Great for workouts', 'Snug and secure fit', 'Good value for money'],
                    cons: ['Sound quality is good, not exceptional', 'Case is a bit bulky', 'No active noise cancellation'],
                    description: 'Designed for active lifestyles, these earbuds stay put no matter how intense your workout.'
                },
                {
                    id: 'bag-a',
                    name: 'Classic Leather Tote',
                    category: 'Bag',
                    price: 250,
                    features: ['Full-grain leather', 'Spacious main compartment', 'Internal pockets', 'Durable stitching'],
                    reviews: { average: 4.6, count: 500 },
                    pros: ['Timeless design', 'Very durable and long-lasting', 'Versatile for daily use'],
                    cons: ['Heavier than fabric bags', 'Requires occasional leather care', 'Higher price'],
                    description: 'An elegant and robust leather tote, perfect for work or everyday style.'
                },
                {
                    id: 'bag-b',
                    name: 'Lightweight Travel Backpack',
                    category: 'Bag',
                    price: 80,
                    features: ['Water-resistant nylon', 'Multiple compartments', 'Padded straps', 'Foldable design'],
                    reviews: { average: 4.4, count: 1100 },
                    pros: ['Extremely lightweight', 'Great for travel and day trips', 'Budget-friendly'],
                    cons: ['Less formal appearance', 'May not withstand very heavy loads over time', 'Limited aesthetic options'],
                    description: 'A practical and lightweight backpack designed for convenience and easy packing.'
                }
            ];

            if (!query) {
                return allProducts;
            }

            const lowerCaseQuery = query.toLowerCase();
            return allProducts.filter(product =>
                product.name.toLowerCase().includes(lowerCaseQuery) ||
                product.description.toLowerCase().includes(lowerCaseQuery) ||
                product.category.toLowerCase().includes(lowerCaseQuery)
            );
        };
        // --- END SIMULATED THIRD-PARTY PRODUCT DATA SERVICE ---

        // Global API Key - will be populated by Canvas environment or use the provided key
        const API_KEY = typeof __api_key !== 'undefined' ? __api_key : "AIzaSyDv2CO9poUllBy5YdpPMdbdloB5OrjzM58";

        // DOM Elements
        const chatWindow = document.getElementById('chatWindow');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const refreshChatButton = document.getElementById('refreshChatButton');
        const recommendProductButton = document.getElementById('recommendProductButton');
        const productModal = document.getElementById('productModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const productsList = document.getElementById('productsList');
        const discountMessageArea = document.getElementById('discountMessageArea');

        // Global state variables
        let chatHistory = [];
        let isLoading = false;

        // Helper function to convert markdown-like bolding and newlines to HTML
        function formatMessageText(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>');
        }

        // Function to display a message in the chat window
        function displayMessage(message) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('flex', 'relative', 'z-10');

            const messageBubble = document.createElement('div');
            messageBubble.classList.add('max-w-[80%]', 'md:max-w-[60%]', 'lg:max-w-[50%]', 'p-4', 'rounded-xl', 'shadow-sm', 'relative', 'break-words');

            const messageText = document.createElement('p');
            messageText.innerHTML = formatMessageText(message.parts[0].text);

            if (message.role === 'user') {
                messageContainer.classList.add('justify-end');
                messageBubble.classList.add('bg-emerald-500', 'text-white', 'rounded-br-none', 'ml-auto');
            } else {
                messageContainer.classList.add('justify-start');
                messageBubble.classList.add('bg-white', 'text-gray-800', 'rounded-bl-none', 'mr-auto');
            }

            messageBubble.appendChild(messageText);
            messageContainer.appendChild(messageBubble);
            chatWindow.appendChild(messageContainer);

            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Function to show/hide loading indicator
        function setLoading(state) {
            isLoading = state;
            messageInput.disabled = state;
            sendMessageButton.disabled = state;
            refreshChatButton.disabled = state;
            recommendProductButton.disabled = state;

            messageInput.placeholder = state ? "Please wait..." : "Type your message...";

            if (state) {
                sendMessageButton.classList.add('disabled:bg-gray-200', 'disabled:text-gray-400', 'disabled:cursor-not-allowed');
                sendMessageButton.classList.remove('bg-emerald-500', 'text-white', 'hover:bg-emerald-600', 'hover:shadow-md');
            } else {
                sendMessageButton.classList.remove('disabled:bg-gray-200', 'disabled:text-gray-400', 'disabled:cursor-not-allowed');
                sendMessageButton.classList.add('bg-emerald-500', 'text-white', 'hover:bg-emerald-600', 'hover:shadow-md');
            }

            const existingLoader = document.getElementById('loadingIndicator');
            if (state && !existingLoader) {
                const loaderContainer = document.createElement('div');
                loaderContainer.id = 'loadingIndicator';
                loaderContainer.classList.add('flex', 'justify-start', 'relative', 'z-10');

                const loaderBubble = document.createElement('div');
                loaderBubble.classList.add('max-w-[80%]', 'md:max-w-[60%]', 'lg:max-w-[50%]', 'p-4', 'rounded-xl', 'shadow-sm', 'bg-white', 'text-gray-800', 'rounded-bl-none', 'mr-auto');

                loaderBubble.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl leading-none animate-bounce-dot-1 text-gray-500">.</span>
                        <span class="text-2xl leading-none animate-bounce-dot-2 text-gray-500">.</span>
                        <span class="text-2xl leading-none animate-bounce-dot-3 text-gray-500">.</span>
                        <span class="ml-2 text-gray-500">Thinking...</span>
                    </div>
                `;
                loaderContainer.appendChild(loaderBubble);
                chatWindow.appendChild(loaderContainer);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            } else if (!state && existingLoader) {
                existingLoader.remove();
            }
        }

        // Function to send message to the Gemini API for general chat
        const sendMessage = async () => {
            const currentMessageText = messageInput.value.trim();
            if (currentMessageText === '') return;

            console.log("Using API Key:", API_KEY); // Log the API key being used

            if (!API_KEY) {
                displayMessage({ role: 'model', parts: [{ text: "API Key is not configured. Please ensure your API key is correctly set up for the Gemini API to function." }] });
                setLoading(false);
                return;
            }

            const newMessage = { role: 'user', parts: [{ text: currentMessageText }] };
            chatHistory.push(newMessage);
            displayMessage(newMessage);
            messageInput.value = '';
            setLoading(true);

            try {
                const initialPrompt = {
                    role: "user",
                    parts: [{
                        text: `You are a friendly, empathetic, and highly knowledgeable product selection consultant. Your primary goal is to help your friend (the user) not just find a product, but truly understand their unique needs and challenges.
                        Always speak in a natural, friendly, and human-like tone. Never mention that you are an AI or a bot.
                        Your responses should be very short and concise, not lengthy.

                        **Special Instruction for Greetings:** If the user simply greets you (e.g., "Hi", "Hello", "Hey"), respond briefly and politely. For example, "Hey there!", "Hi!", or "Hello!". Then, gently guide them back to their product needs.

                        **Questioning Style:** When asking questions to understand their needs, ask them one at a time. Keep each question concise and focused. Maintain a beautiful and friendly speaking structure throughout.

                        **Core Features to Emphasize:**
                        1.  **Understanding Customer Needs:** Actively listen to their initial problem and ask follow-up questions to dig deeper into their specific situation, preferences, and what they hope to achieve.
                        2.  **Helping Customers Understand Their Needs:** Guide them to clarify their own requirements. If their initial request is vague, ask clarifying questions in a friendly way to help them articulate their ideal solution. For example, "That's a great start! To help me narrow it down, could you tell me a bit more about how you plan to use it?" or "What's most important to you, like budget, size, or specific features?"
                        3.  **Proactive Information Gathering for "Bag Product":** If the user mentions a "bag" or similar item, immediately ask about their budget AND their primary focus. Specifically, ask if they prioritize "beauty/design," "durability/longevity," "cost-effectiveness," "performance," "sustainability," or other specific qualities. Ask these as distinct, single questions if possible.
                        4.  **Deep Analysis and Product Recommendation:** Once you have a clear picture of their needs (including budget and priorities), you will perform a deep analysis. Frame your recommendations as insights gathered from "deep research" and by reviewing "various articles" or "expert reviews." You can say things like, "Based on our chat and what I've learned from my research..." or "Looking at various reviews and articles, it seems like [Product Type] would be a great fit because..."
                        5.  **Feature Improvement Requests:** When a user expresses a need or suggests an improvement for a product or feature, actively inquire about their priorities and preferences to tailor your response. Ask clarifying questions to understand whether they value aesthetics (e.g., beauty, design), durability (e.g., longevity, robustness), cost-effectiveness (e.g., budget-friendly), performance (e.g., speed, efficiency), sustainability, or other specific qualities. Then, provide a response that aligns with their stated priorities, offering relevant suggestions or explanations to address their need effectively.

                        Your responses should be very short and concise, not lengthy.
                        Once you have a clear picture, you will recommend the best product or type of product for their problem, with confidence and a friendly assurance like "Insha Allah" if it's appropriate.
                        Start by warmly greeting your friend and asking them what kind of problem they're trying to solve or what they're looking for help with today.
                        `
                    }]
                };

                let productDataString = '';
                const lastUserMessageText = chatHistory[chatHistory.length - 1].parts[0].text.toLowerCase();
                if (lastUserMessageText.includes('bag') || lastUserMessageText.includes('laptop') || lastUserMessageText.includes('headphone')) {
                    const products = await mockProductDataService(lastUserMessageText);
                    productDataString = JSON.stringify(products, null, 2);
                }

                const payload = {
                    contents: [
                        initialPrompt,
                        ...chatHistory,
                        ...(productDataString ? [{ role: 'user', parts: [{ text: `(Internal data for analysis: ${productDataString})` }] }] : [])
                    ],
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API response not OK for general chat:", response.status, errorData);
                    throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let aiResponseText = result.candidates[0].content.parts[0].text;

                    const discountKeywords = ['discount', 'offer', 'deal', 'promo', 'coupon'];
                    const userAskedForDiscount = discountKeywords.some(keyword => lastUserMessageText.includes(keyword));

                    if (userAskedForDiscount) {
                        aiResponseText += "\n\nFor more detailed information and exclusive discounts, feel free to contact us at **alshakil.bd03@gmail.com**.";
                    }

                    const aiMessage = { role: 'model', parts: [{ text: aiResponseText }] };
                    chatHistory.push(aiMessage);
                    displayMessage(aiMessage);
                } else {
                    console.error("Unexpected API response structure for general chat (missing candidates/content/parts):", result);
                    const errorMessage = { role: 'model', parts: [{ text: "I apologize, but I couldn't generate a response. The AI did not provide valid content. Please try again." }] };
                    chatHistory.push(errorMessage);
                    displayMessage(errorMessage);
                }
            } catch (error) {
                console.error("Error communicating with Gemini API for general chat:", error);
                const errorMessage = { role: 'model', parts: [{ text: `I'm having trouble connecting right now. This might be a network issue or a problem with the AI service. Error: ${error.message}. Please check your internet connection or try again later.` }] };
                chatHistory.push(errorMessage);
                displayMessage(errorMessage);
            } finally {
                setLoading(false);
            }
        };

        // Function to handle refreshing the chat
        const handleRefreshChat = () => {
            chatHistory = [];
            chatWindow.innerHTML = '';
            const watermarkDiv = document.createElement('div');
            watermarkDiv.id = 'watermark';
            watermarkDiv.className = 'absolute inset-0 flex items-center justify-center pointer-events-none z-0 opacity-20 text-gray-300 text-5xl font-bold uppercase tracking-widest';
            watermarkDiv.textContent = 'Shopping Assistant';
            chatWindow.appendChild(watermarkDiv);

            messageInput.value = '';
            setLoading(false);
            displayMessage({ role: 'model', parts: [{ text: "Hey there, friend! What kind of problem are you trying to solve, or what are you looking for help with today? Tell me all about it!" }] });
        };

        // Function to display products in the modal
        const displayProductsInModal = (products) => {
            productsList.innerHTML = '';
            discountMessageArea.classList.add('hidden');

            if (!products || products.length === 0) {
                productsList.innerHTML = '<p class="text-center text-gray-500">No specific recommendations at this moment. Please provide more details in the chat!</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('bg-gray-50', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-100', 'flex', 'flex-col');
                productCard.innerHTML = `
                    <h3 class="text-lg font-semibold text-emerald-700 mb-1">${product.name}</h3>
                    <p class="text-gray-600 text-sm"><strong>Category:</strong> ${product.category}</p>
                    <p class="text-gray-800 font-bold text-lg mb-2">$${product.price.toFixed(2)}</p>
                    <p class="text-gray-700 text-sm mb-2">${product.description}</p>
                    <div class="text-xs text-gray-500 mb-3">
                        <p><strong>Features:</strong> ${product.features.join(', ')}</p>
                        <p><strong>Reviews:</strong> ${product.reviews.average} (${product.reviews.count} reviews)</p>
                        <p><strong>Pros:</strong> ${product.pros.join(', ')}</p>
                        <p><strong>Cons:</strong> ${product.cons.join(', ')}</p>
                    </div>
                    <button class="discount-button mt-auto px-4 py-2 bg-emerald-100 text-emerald-700 rounded-full text-sm font-semibold hover:bg-emerald-200 transition-colors duration-200 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tag"><path d="M12.22 2H2v10.22a2 2 0 0 0 .59 1.41l9.23 9.23a2.4 2.4 0 0 0 3.4 0l6.59-6.59a2.4 2.4 0 0 0 0-3.4L13.63 2.59a2 2 0 0 0-1.41-.59Z"/><circle cx="7" cy="7" r="2"/></svg>
                        <span>Get Discount!</span>
                    </button>
                `;
                productsList.appendChild(productCard);
            });

            document.querySelectorAll('.discount-button').forEach(button => {
                button.addEventListener('click', () => {
                    discountMessageArea.classList.remove('hidden');
                    discountMessageArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
            });
        };

        // Function to handle product recommendation request
        const handleProductRecommendation = async () => {
            setLoading(true);

            console.log("Using API Key:", API_KEY); // Log the API key being used

            if (!API_KEY) {
                displayMessage({ role: 'model', parts: [{ text: "API Key is not configured. Please ensure your API key is correctly set up for the Gemini API to function." }] });
                setLoading(false);
                return;
            }

            try {
                const availableProducts = await mockProductDataService();

                const recommendationPrompt = {
                    role: "user",
                    parts: [{
                        text: `Based on our current conversation history (up to this point), please recommend the TOP 1-3 products that best fit the user's needs.
                        Provide your recommendation as a JSON array of objects, where each object represents a product from the provided list.
                        If you cannot find a suitable product, return an empty array.
                        Include the 'id', 'name', 'category', 'price', 'features', 'reviews', 'pros', 'cons', and 'description' for each recommended product.
                        Do NOT include any additional text outside the JSON array in your response.

                        Current chat history for analysis:
                        ${JSON.stringify(chatHistory, null, 2)}

                        Available products for consideration:
                        ${JSON.stringify(availableProducts, null, 2)}
                        `
                    }]
                };

                const payload = {
                    contents: [
                        recommendationPrompt
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "id": { "type": "STRING" },
                                    "name": { "type": "STRING" },
                                    "category": { "type": "STRING" },
                                    "price": { "type": "NUMBER" },
                                    "features": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING" }
                                    },
                                    "reviews": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "average": { "type": "NUMBER" },
                                            "count": { "type": "NUMBER" }
                                        }
                                    },
                                    "pros": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING" }
                                    },
                                    "cons": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING" }
                                    },
                                    "description": { "type": "STRING" }
                                },
                                "required": ["id", "name", "category", "price", "features", "reviews", "pros", "cons", "description"]
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API response not OK for recommendation:", response.status, errorData);
                    throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    let recommendedProducts = [];

                    try {
                        recommendedProducts = JSON.parse(jsonString);
                    } catch (parseError) {
                        console.error("Error parsing AI JSON response for recommendation:", parseError, "Raw AI response:", jsonString);
                        displayProductsInModal([]); // Show empty state in modal
                        productModal.classList.remove('hidden');
                        const errorMessage = { role: 'model', parts: [{ text: "I received a recommendation, but there was an issue processing it. The AI might have provided an unexpected format. Please try again." }] };
                        chatHistory.push(errorMessage);
                        displayMessage(errorMessage);
                        return;
                    }

                    displayProductsInModal(recommendedProducts);
                    productModal.classList.remove('hidden');

                } else {
                    console.error("Unexpected API response structure for recommendation (missing candidates/content/parts):", result);
                    displayProductsInModal([]); // Show empty state in modal
                    productModal.classList.remove('hidden');
                    const errorMessage = { role: 'model', parts: [{ text: "I apologize, but I couldn't generate a product recommendation. The AI did not provide a valid response. Please try again." }] };
                    chatHistory.push(errorMessage);
                    displayMessage(errorMessage);
                }
            } catch (error) {
                console.error("Error communicating with Gemini API for recommendation:", error);
                const errorMessage = { role: 'model', parts: [{ text: `I'm having trouble getting recommendations right now. This might be a network issue or a problem with the AI service. Error: ${error.message}. Please check your internet connection or try again later.` }] };
                chatHistory.push(errorMessage);
                displayMessage(errorMessage);
            } finally {
                setLoading(false);
            }
        };


        // Event Listeners
        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        });
        refreshChatButton.addEventListener('click', handleRefreshChat);
        recommendProductButton.addEventListener('click', handleProductRecommendation);
        closeModalButton.addEventListener('click', () => {
            productModal.classList.add('hidden');
            discountMessageArea.classList.add('hidden');
        });


        // Initial greeting when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            displayMessage({ role: 'model', parts: [{ text: "Hey there, friend! What kind of problem are you trying to solve, or what are you looking for help with today? Tell me all about it!" }] });
        });
    </script>
</body>
</html>
